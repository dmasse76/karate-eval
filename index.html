<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Évaluation – 5 questions</title>
    <style>
        :root{
            --bg:#0f172a; /* slate-900 */
            --card:#111827; /* gray-900 */
            --muted:#94a3b8; /* slate-400 */
            --text:#e5e7eb; /* gray-200 */
            --accent:#22c55e; /* green-500 */
            --accent-2:#f59e0b; /* amber-500 */
            --danger:#ef4444; /* red-500 */
            --btn:#1f2937; /* gray-800 */
            --ring:#38bdf8; /* sky-400 */
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0;
            /* Background nuancé avec image plus visible */
            background:
                    linear-gradient(180deg,rgba(15,23,42,0.80) 60%,rgba(2,6,23,0.92) 100%),
                    url('shinden-ryu-logo.png') center 140px/320px no-repeat,
                    linear-gradient(180deg,var(--bg),#020617);
            color:var(--text);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
            -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
        }
        .wrap{max-width:760px;margin:0 auto;padding:16px; padding-bottom:96px}
        .card{
            background:linear-gradient(180deg,var(--card),#0b1220);
            border:1px solid #1f2937;
            border-radius:18px;
            padding:16px;
            box-shadow:0 8px 32px rgba(0,0,0,.4);
            backdrop-filter: blur(3px);
        }
        h1{font-size:1.35rem;margin:8px 0 2px}
        h2{font-size:1rem;margin:16px 0 8px;color:var(--muted)}
        .row{display:grid;grid-template-columns:1fr;gap:10px;margin:10px 0}
        label{font-size:.95rem}
        input[type="text"], textarea, select{
            width:100%;
            background:#0b1220;
            color:var(--text);
            border:1px solid #1f2937;
            border-radius:12px;
            padding:12px 14px;
            font-size:1rem;
            outline:none;
        }
        input[type="text"]:focus, textarea:focus, select:focus{border-color:var(--ring); box-shadow:0 0 0 4px rgba(56,189,248,.15)}
        textarea{min-height:96px; resize:vertical}
        .seg{
            display:flex;gap:8px;flex-wrap:wrap;margin-top:6px
        }
        .seg input{display:none}
        .seg label{
            flex:1 0 calc(20% - 6px);
            text-align:center;
            padding:12px 0;
            border-radius:12px;
            background:#0b1220;
            border:1px solid #1f2937;
            font-weight:600;
            font-size:1rem;
            line-height:1;
            user-select:none;
        }
        .seg input:checked + label{
            background:linear-gradient(180deg,#0ea5e9,#22c55e);
            color:white;
            border-color:transparent;
            box-shadow:0 6px 22px rgba(34,197,94,.35);
        }
        .q{padding:12px;border:1px dashed #233147;border-radius:14px;margin:10px 0}
        .q .title{font-weight:700;font-size:1.02rem}
        .muted{color:var(--muted);font-size:.9rem}
        .pill{
            display:inline-block;
            padding:6px 10px;border-radius:999px;font-size:.85rem;margin-left:8px
        }
        .pill.ok{background:#052e1a;color:#86efac;border:1px solid #14532d}
        .pill.warn{background:#341a05;color:#fcd34d;border:1px solid #78350f}
        .pill.bad{background:#3b0a0a;color:#fecaca;border:1px solid #7f1d1d}
        .grid2{display:grid;grid-template-columns:1fr 1fr; gap:8px}
        .btn{
            display:inline-flex;align-items:center;justify-content:center;
            gap:8px;
            padding:12px 14px;border-radius:12px;border:1px solid #1f2937;
            background:linear-gradient(180deg,#0b1220,#0a0f1d);
            color:var(--text);font-weight:700;text-decoration:none;
            width:100%;
        }
        .btn:active{transform:translateY(1px)}
        .btn.primary{background:linear-gradient(180deg,#0284c7,#0369a1); border-color:#0ea5e9}
        .btn.success{background:linear-gradient(180deg,#16a34a,#15803d); border-color:#22c55e}
        .btn.warn{background:linear-gradient(180deg,#d97706,#b45309); border-color:#f59e0b}
        .btn.neutral{}
        .scoreBox{
            display:flex; align-items:center; justify-content:space-between; gap:10px;
            border:1px solid #1f2937;border-radius:14px;padding:12px 14px;margin-top:8px;
            background:#0b1220;
        }
        .scoreBox .score{font-size:1.3rem;font-weight:800}
        .footer{
            position:sticky; bottom:0; left:0; right:0;
            background:linear-gradient(180deg, rgba(2,6,23,.2), rgba(2,6,23,.95));
            backdrop-filter: blur(6px);
            border-top:1px solid #1f2937;
            padding:12px 16px;
        }
        small{color:var(--muted)}
        .history-item{
            border:1px solid #1f2937;border-radius:12px;padding:10px;margin-top:8px;background:#060b16
        }
        .kbadge{font-size:.8rem;padding:2px 6px;border:1px solid #1f2937;border-radius:999px;margin-left:6px;color:#a3e635;background:#052e1a}
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
        .logo-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1000;
            pointer-events: none;
            background: url('shinden-ryu-logo.png') center 180px/380px no-repeat;
            opacity: 0.28;
            filter: drop-shadow(0 0 16px #0008) brightness(1.15);
            width: 100vw;
            height: 100vh;
        }
        .wrap, .card, .cat-section {
            position: relative;
            z-index: 1100;
        }
        .card {
            background: linear-gradient(180deg, rgba(17,24,39,0.82), rgba(11,18,32,0.80));
        }
        .cat-section {
            background: linear-gradient(180deg, rgba(30,41,59,0.78) 80%, rgba(11,18,32,0.75) 100%);
        }
    </style>
    <style>
        .cat-section {
            margin: 28px 0 32px 0;
            padding: 18px 12px 12px 12px;
            border-radius: 18px;
            background: linear-gradient(180deg, #1e293b 80%, #0b1220 100%);
            border: 1.5px solid #233147;
            box-shadow: 0 2px 12px rgba(30,41,59,0.08);
        }
        .cat-title {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.18rem;
            color: var(--accent);
            letter-spacing: 0.01em;
            font-weight: 700;
        }
        @media (max-width: 600px) {
            .cat-section { padding: 10px 4px 8px 4px; }
            .cat-title { font-size: 1.05rem; }
        }
    </style>
</head>
<body>
<!-- Logo overlay supprimé, image unique en overlay -->
<div class="logo-bg"></div>
<!-- <img src="shinden-ryu-logo.png" ...> supprimé -->
<div class="wrap">
    <div class="card">
        <h1>Évaluation technique – 5 questions <span class="kbadge">Mobile</span></h1>
        <p class="muted">Saisie rapide pour passage de grade (hors-ligne). Les données restent sur votre téléphone.</p>

        <div class="row">
            <div class="grid2">
                <div>
                    <label for="eleve-header">Nom du candidat</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <select id="eleve-header" style="flex:1" aria-label="Sélectionner un élève (haut)">
                            <option value="">— Sélectionner —</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="evaluator">Évaluateur / trice</label>
                    <input id="evaluator" type="text" placeholder="Votre nom" autocomplete="name" />
                </div>
            </div>
            <div class="grid2">
                <div>
                    <label for="date">Date</label>
                    <input id="date" type="text" inputmode="numeric" placeholder="AAAA-MM-JJ" />
                </div>
                <div>
                    <label for="level">Niveau</label>
                    <select id="level">
                        <option value="">— Sélectionner —</option>
                        <option>Brune</option>
                        <option>Noire</option>
                        <option>Bleue</option>
                        <option>Verte</option>
                        <option>Orange</option>
                        <option>Jaune</option>
                        <option>Blanche</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Questions -->
        <div id="questions"></div>

        <div class="scoreBox">
            <div>
                <div class="muted">Score total</div>
                <div class="score" id="score">0 / 25</div>
            </div>
            <div id="verdict" class="pill warn">À évaluer</div>
        </div>

        <h2>Commentaires</h2>
        <label for="notes" class="visually-hidden">Commentaires</label>
        <textarea id="notes" placeholder="Points forts, axes d'amélioration, sécurité, attitude…"></textarea>

        <div class="row" style="margin-top:14px">
            <div class="grid2">
                <button class="btn primary" id="btn-save">Enregistrer dans l’historique</button>
                <button class="btn neutral" id="btn-reset">Réinitialiser</button>
            </div>
            <div class="grid2">
                <button class="btn success" id="btn-share">Partager / Copier</button>
                <button class="btn warn" id="btn-export">Exporter CSV</button>
            </div>
        </div>

        <h2>Historique (sur cet appareil)</h2>
        <div id="history"></div>

        <p class="muted"><small>Astuce : ajoutez cette page à l’écran d’accueil pour un accès rapide. Aucune connexion requise, aucune donnée envoyée en ligne.</small></p>
    </div>
</div>

<div class="footer">
    <div class="grid2">
        <a class="btn" href="#" id="btn-install">Installer (écran d’accueil)</a>
        <a class="btn" href="#" id="btn-dark">Mode sombre</a>
    </div>
</div>

<script>
    // ---- Configuration des 5 questions (libellés) ----
    const Q = [
        {key:'kihon', title:'Kihon', help:'Bases techniques'},
        {key:'kata', title:'Kata', help:'Exécution'},
        {key:'kumite', title:'Kumite', help:'Application'},
        {key:'cond', title:'Conditionnement', help:'Conditionnement'},
        {key:'att', title:'Attitude & Do', help:'Attitude & Do'}
    ];
    const SUBS = [1,2,3];

    // ---- Helpers ----
    const $ = (s)=>document.querySelector(s);
    const el = (tag, attrs={}) => Object.assign(document.createElement(tag), attrs);

    // --- Nouvelle logique dynamique par ceinture ---
    const LEVEL_JSON = {
        'Blanche': 'questions-blanche.json',
        'Brune': 'questions-brune.json',
        'Verte': 'questions-verte.json',
        // Ajouter d'autres couleurs ici
    };
    let currentCategories = [];
    let currentEleves = [];

    // Met à jour dynamiquement le menu Niveau
    function updateLevelMenu() {
        const levelSelect = document.getElementById('level');
        if (!levelSelect) return;
        levelSelect.innerHTML = '<option value="">— Sélectionner —</option>';
        Object.keys(LEVEL_JSON).forEach(level => {
            const opt = document.createElement('option');
            opt.value = level;
            opt.textContent = level;
            levelSelect.appendChild(opt);
        });
    }
    updateLevelMenu();

    async function loadQuestionsForLevel(level) {
        const file = LEVEL_JSON[level] || LEVEL_JSON['Blanche'];
        try {
            const resp = await fetch(file);
            const data = await resp.json();
            currentCategories = data.categories;
            currentEleves = Array.isArray(data.eleves) ? data.eleves.slice() : [];
            renderQuestions();
            loadElevesFromJson();
        } catch (e) {
            currentCategories = [];
            currentEleves = [];
            $('#questions').innerHTML = '<div class="muted">Erreur de chargement du formulaire.</div>';
        }
    }

    function loadElevesFromJson() {
        // Remplit tous les selects d'élèves à partir de currentEleves
        eleveSelectors.forEach(id => {
            const sel = document.getElementById(id);
            if (!sel) return;
            sel.innerHTML = '<option value="">— Sélectionner —</option>';
            currentEleves.forEach(nom => {
                const opt = document.createElement('option');
                opt.value = nom; opt.textContent = nom;
                sel.appendChild(opt);
            });
        });
        syncAllEleveSelectors(currentEleve);
    }

    // --- Variables globales pour la gestion multi-élèves ---
    let eleveSelectors = [];
    let eleveAddButtons = [];
    let eleveNewInputs = [];

    function renderQuestions() {
        const $box = $('#questions');
        $box.innerHTML = '';
        // Réinitialise les tableaux globaux
        eleveSelectors.length = 0;
        eleveAddButtons.length = 0;
        eleveNewInputs.length = 0;
        eleveSelectors.push('eleve-header');
        currentCategories.forEach((cat) => {
            const section = el('div', {className: 'cat-section'});
            const sectionTitle = el('h2', {className: 'cat-title', textContent: cat.title});
            section.appendChild(sectionTitle);
            // Bloc sélecteur d'élève pour cette section (sans bouton + ni input)
            const selRow = el('div', {style: 'display: flex; gap: 0.5rem; align-items: center; margin-bottom: 10px;'});
            const sel = el('select', {id: `eleve-section-${cat.key}`, style: 'flex:1', 'aria-label': `Sélectionner un élève (${cat.title})`});
            sel.innerHTML = '<option value="">— Sélectionner —</option>';
            selRow.appendChild(sel);
            section.appendChild(selRow);
            eleveSelectors.push(sel.id);
            cat.subTechniques.forEach((subName, subIdx) => {
                const wrap = el('div',{className:'q', id:`q-${cat.key}-${subIdx+1}`});
                const title = el('div',{className:'title', textContent:`${cat.title} | ${subName}`});
                const help = el('div',{className:'muted', textContent:cat.help});
                const seg = el('div',{className:'seg'});
                for(let v=1; v<=4; v++){
                    const id = `${cat.key}-${subIdx+1}-${v}`;
                    const inputRadio = el('input',{type:'radio', name:`${cat.key}_${subIdx+1}`, id, value:v});
                    const label = el('label',{htmlFor:id, textContent:String(v), role:'button', 'aria-label':`${cat.title} | ${subName} : ${v}`});
                    seg.appendChild(inputRadio);
                    seg.appendChild(label);
                }
                wrap.appendChild(title); wrap.appendChild(help); wrap.appendChild(seg);
                section.appendChild(wrap);
            });
            $box.appendChild(section);
        });
        // Réinitialiser la logique multi-élèves après le rendu
        setupEleveListeners();
    }

    // --- Changement de ceinture ---
    $('#level').addEventListener('change', (e) => {
        loadQuestionsForLevel(e.target.value);
    });
    // Chargement initial (par défaut sur Blanche)
    loadQuestionsForLevel($('#level').value || 'Blanche');

    // Prefill date
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,'0');
    $('#date').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

    // Calcul du score dynamique
    function getScore(){
        let s = 0;
        currentCategories.forEach(cat => {
            cat.subTechniques.forEach((_, subIdx) => {
                const checked = document.querySelector(`input[name="${cat.key}_${subIdx+1}"]:checked`);
                if(checked) s += Number(checked.value||0);
            });
        });
        return s;
    }
    function updateScore(){
        let maxScore = 0;
        currentCategories.forEach(cat => { maxScore += cat.subTechniques.length * 4; });
        const s = getScore();
        $('#score').textContent = `${s} / ${maxScore}`;
        const v = $('#verdict');
        v.className = 'pill';
        if(s >= maxScore * 0.88){ v.classList.add('ok'); v.textContent='Réussi (excellent)'; }
        else if(s >= maxScore * 0.72){ v.classList.add('warn'); v.textContent='Réussi (à consolider)'; }
        else if(s>0){ v.classList.add('bad'); v.textContent='À revoir / Ajourné'; }
        else       { v.classList.add('warn'); v.textContent='À évaluer'; }
    }
    document.addEventListener('change', (e)=>{
        if(e.target && e.target.matches('input[type="radio"]')) updateScore();
    });
    updateScore();

    // Sauvegarde dynamique
    function saveCurrent(){
        const data = {
            candidate: $('#eleve-header').value.trim(),
            evaluator: $('#evaluator').value.trim(),
            date: $('#date').value.trim(),
            level: $('#level').value,
            notes: $('#notes').value.trim(),
            answers: {}
        };
        currentCategories.forEach(cat => {
            cat.subTechniques.forEach((_, subIdx) => {
                const checked = document.querySelector(`input[name="${cat.key}_${subIdx+1}"]:checked`);
                data.answers[`${cat.key}_${subIdx+1}`] = checked ? Number(checked.value) : null;
            });
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    function loadCurrent(){
        try{
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
            if(!data) return;
            $('#eleve-header').value = data.candidate||'';
            $('#evaluator').value = data.evaluator||'';
            $('#date').value = data.date||$('#date').value;
            $('#level').value = data.level||'';
            $('#notes').value = data.notes||'';
            if(data.answers){
                currentCategories.forEach(cat => {
                    cat.subTechniques.forEach((_, subIdx) => {
                        const val = data.answers[`${cat.key}_${subIdx+1}`];
                        if(val){
                            const elx = document.getElementById(`${cat.key}-${subIdx+1}-${val}`);
                            if(elx) elx.checked = true;
                        }
                    });
                });
            }
            updateScore();
        }catch(e){}
    }
    ['input','change','keyup'].forEach(evt=>{
        document.addEventListener(evt, (e)=>{
            if(e.target && (e.target.matches('input, textarea, select'))) saveCurrent();
        });
    });
    loadCurrent();

    // History rendering
    function getHistory(){
        try{ return JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]'); }catch(e){ return []; }
    }
    function setHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }
    function renderHistory(){
        const box = $('#history');
        box.innerHTML='';
        const list = getHistory().slice().reverse();
        if(list.length===0){
            box.innerHTML = '<div class="muted">Aucun enregistrement pour le moment.</div>';
            return;
        }
        list.forEach((item)=>{
            const div = el('div',{className:'history-item'});
            const head = el('div',{innerHTML:`<strong>${item.candidate||'—'}</strong> · ${item.level||'—'} · ${item.date||'—'}
      <span class="pill ${item.verdictClass}">${item.verdict}</span>`});
            const body = el('div',{className:'muted', textContent:`Évaluateur: ${item.evaluator||'—'} · Score: ${item.score}/25`});
            const notes = el('div',{textContent:item.notes||'', style:'margin-top:6px; white-space:pre-wrap'});
            const btns = el('div',{style:'display:flex; gap:8px; margin-top:8px'});
            const bcopy = el('button',{className:'btn', textContent:'Copier'});
            const bdel = el('button',{className:'btn warn', textContent:'Supprimer'});
            bcopy.onclick = ()=> copyText(toText(item));
            bdel.onclick = ()=>{
                const hist = getHistory();
                const ix = hist.findIndex(x=>x.id===item.id);
                if(ix>-1){ hist.splice(ix,1); setHistory(hist); renderHistory(); }
            };
            btns.appendChild(bcopy); btns.appendChild(bdel);
            div.appendChild(head); div.appendChild(body); if(item.notes) div.appendChild(notes); div.appendChild(btns);
            box.appendChild(div);
        });
    }
    function verdictFromScore(s){
        const maxScore = Q.length * SUBS.length * 4;
        if(s >= maxScore * 0.88) return {text:'Réussi (excellent)', cls:'ok'};
        if(s >= maxScore * 0.72) return {text:'Réussi (à consolider)', cls:'warn'};
        if(s>0)   return {text:'À revoir / Ajourné', cls:'bad'};
        return {text:'À évaluer', cls:'warn'};
    }
    function toText(item){
        const lines = [];
        lines.push(`ÉVALUATION – Techniques`);
        lines.push(`Date : ${item.date||'—'}`);
        lines.push(`Candidat : ${item.candidate||'—'}`);
        lines.push(`Niveau : ${item.level||'—'}`);
        lines.push(`Évaluateur : ${item.evaluator||'—'}`);
        lines.push(`Score : ${item.score}/${Q.length * SUBS.length * 4} – ${item.verdict}`);
        Q.forEach((q)=>{
            SUBS.forEach((subIdx) => {
                lines.push(`${q.title} | Technique ${subIdx}: ${item.answers[`${q.key}_${subIdx}`]||'—'}/4`);
            });
        });
        if(item.notes){
            lines.push('Notes :');
            lines.push(item.notes);
        }
        return lines.join('\n');
    }

    // Save current as history entry
    $('#btn-save').addEventListener('click', ()=>{
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
        let score = 0;
        Q.forEach(q=>{
            SUBS.forEach(subIdx => {
                score += Number(data.answers?.[`${q.key}_${subIdx}`]||0);
            });
        });
        const maxScore = Q.length * SUBS.length * 4;
        const v = verdictFromScore(score);
        const entry = {
            id: Date.now(),
            ...data,
            score,
            verdict: v.text,
            verdictClass: v.cls
        };
        const hist = getHistory();
        hist.push(entry);
        setHistory(hist);
        renderHistory();
        alert('Enregistré dans l’historique.');
    });

    // Reset
    $('#btn-reset').addEventListener('click', ()=>{
        if(!confirm('Effacer le formulaire en cours ?')) return;
        localStorage.removeItem(STORAGE_KEY);
        document.querySelectorAll('input[type="text"]').forEach(i=>i.value='');
        document.querySelectorAll('textarea').forEach(i=>i.value='');
        document.querySelectorAll('select').forEach(i=>i.value='');
        document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false);
        updateScore();
    });

    // Share / Copy
    async function copyText(text){
        try{
            await navigator.clipboard.writeText(text);
            alert('Copié dans le presse-papiers.');
        }catch{
            // Fallback: prompt
            window.prompt('Copiez manuellement : Ctrl+C/OK', text);
        }
    }
    $('#btn-share').addEventListener('click', async ()=>{
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
        let score = 0; Q.forEach(q=>{ SUBS.forEach(subIdx => { score += Number(data.answers?.[`${q.key}_${subIdx}`]||0); }); });
        const maxScore = Q.length * SUBS.length * 4;
        const v = verdictFromScore(score);
        const entry = { ...data, score, verdict:v.text, answers:data.answers||{} };
        const text = toText(entry);
        if(navigator.share){
            try{ await navigator.share({text}); }
            catch(e){ /* canceled */ }
        } else {
            copyText(text);
        }
    });

    // Export CSV (history)
    $('#btn-export').addEventListener('click', ()=>{
        const hist = getHistory();
        if(hist.length===0){ alert('Historique vide.'); return; }
        const headers = ['date','candidate','level','evaluator','score','verdict', ...Q.flatMap(q=>SUBS.map(subIdx=>`${q.key}_${subIdx}`)), 'notes'];
        const rows = hist.map(item=>{
            return [
                item.date||'',
                item.candidate||'',
                item.level||'',
                item.evaluator||'',
                item.score||'',
                item.verdict||'',
                ...Q.flatMap(q=>SUBS.map(subIdx=> item.answers?.[`${q.key}_${subIdx}`] ?? '')),
                (item.notes||'').replace(/\n/g,' ').replace(/"/g,'""')
            ];
        });
        const csv = [headers.join(','), ...rows.map(r=> r.map(x=> `"${String(x)}"`).join(','))].join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'evaluations_techniques.csv'; a.click();
        URL.revokeObjectURL(url);
    });

    // Dark/light toggle (kept simple)
    let dark = true;
    const btnDark = document.getElementById('btn-dark');
    if (btnDark) {
        btnDark.textContent = dark ? 'Mode clair' : 'Mode sombre';
        btnDark.addEventListener('click', ()=>{
            dark = !dark;
            document.body.style.filter = dark ? 'none' : 'invert(1) hue-rotate(180deg)';
            btnDark.textContent = dark ? 'Mode clair' : 'Mode sombre';
        });
    }

    // Install hint (Add to Home Screen)
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; });
    $('#btn-install').addEventListener('click', async ()=>{
        if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; }
        else alert('Utilisez « Ajouter à l’écran d’accueil » dans le menu du navigateur.');
    });

    // Update score on load
    updateScore();
    // --- Gestion multi-élèves synchronisée (header + sections) ---
    const ELEVE_KEY = 'eval5q.eleves';
    let eleves = {};
    let currentEleve = '';
    function syncAllEleveSelectors(selected) {
        eleveSelectors.forEach(id => {
            const s = document.getElementById(id);
            if (s) s.value = selected;
        });
    }
    function loadEleves() {
        try { eleves = JSON.parse(localStorage.getItem(ELEVE_KEY)||'{}'); } catch { eleves = {}; }
        eleveSelectors.forEach(id => {
            const sel = document.getElementById(id);
            if (!sel) return;
            // Efface toutes les options sauf la première ("— Sélectionner —")
            sel.innerHTML = '<option value="">— Sélectionner —</option>';
        });
        Object.keys(eleves).forEach(nom => {
            eleveSelectors.forEach(id => {
                const sel = document.getElementById(id);
                if (!sel) return;
                // Ajoute l'option seulement si elle n'existe pas déjà
                if (!Array.from(sel.options).some(opt => opt.value === nom)) {
                    const opt = document.createElement('option');
                    opt.value = nom; opt.textContent = nom;
                    sel.appendChild(opt);
                }
            });
        });
        syncAllEleveSelectors(currentEleve);
    }
    function saveEleves() {
        localStorage.setItem(ELEVE_KEY, JSON.stringify(eleves));
    }
    function saveCurrentEleve() {
        if (!currentEleve) return;
        const data = {
            candidate: currentEleve,
            evaluator: $('#evaluator').value.trim(),
            date: $('#date').value.trim(),
            level: $('#level').value,
            notes: $('#notes').value.trim(),
            answers: {}
        };
        // Utiliser la structure dynamique pour la sauvegarde des réponses
        currentCategories.forEach(cat => {
            cat.subTechniques.forEach((_, subIdx) => {
                const checked = document.querySelector(`input[name="${cat.key}_${subIdx+1}"]:checked`);
                data.answers[`${cat.key}_${subIdx+1}`] = checked ? Number(checked.value) : null;
            });
        });
        eleves[currentEleve] = data;
        saveEleves();
    }
    function loadCurrentEleve(nom) {
        const data = eleves[nom] || {};
        $('#evaluator').value = data.evaluator || '';
        $('#date').value = data.date || $('#date').value;
        // NE PAS toucher au niveau lors du changement d'élève
        // $('#level').value = data.level || '';
        $('#notes').value = data.notes || '';
        // Utiliser la structure dynamique pour les notes
        currentCategories.forEach(cat => {
            cat.subTechniques.forEach((_, subIdx) => {
                // Décocher toutes les radios de cette sous-technique
                document.querySelectorAll(`input[name="${cat.key}_${subIdx+1}"]`).forEach(i => i.checked = false);
                const val = data.answers ? data.answers[`${cat.key}_${subIdx+1}`] : null;
                if (val) {
                    const elx = document.getElementById(`${cat.key}-${subIdx+1}-${val}`);
                    if (elx) elx.checked = true;
                }
            });
        });
        syncAllEleveSelectors(nom);
        updateScore();
    }
    function setupEleveListeners() {
        let isSyncing = false;
        eleveSelectors.forEach(id => {
            const sel = document.getElementById(id);
            if (!sel) return;
            sel.addEventListener('change', e => {
                if (isSyncing) return;
                isSyncing = true;
                currentEleve = e.target.value;
                // Synchronise tous les selects
                eleveSelectors.forEach(otherId => {
                    const otherSel = document.getElementById(otherId);
                    if (otherSel && otherSel.value !== currentEleve) {
                        otherSel.value = currentEleve;
                    }
                });
                // Charge les données de l'élève sélectionné dans tout le formulaire
                if (currentEleve) {
                    loadCurrentEleve(currentEleve);
                } else {
                    document.querySelectorAll('input[type="text"]').forEach(i=>i.value='');
                    document.querySelectorAll('textarea').forEach(i=>i.value='');
                    document.querySelectorAll('select').forEach(i=>i.value='');
                    document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false);
                    updateScore();
                }
                isSyncing = false;
            });
        });
        // Suppression de la gestion du bouton + et de l'input d'ajout
    }
    // Initialisation des élèves
    loadEleves();
    setupEleveListeners();
    // Sauvegarde automatique par élève
    ['input','change','keyup'].forEach(evt => {
        document.addEventListener(evt, e => {
            if (e.target && (e.target.matches('input, textarea, select'))) {
                saveCurrentEleve();
            }
        });
    });
    // Suppression du bouton d'effacement des élèves dans le footer
    const footer = document.querySelector('.footer .grid2');
    if (footer) {
        const btnClear = document.getElementById('btn-clear-eleves');
        if (btnClear) btnClear.remove();
    }
</script>
</body>
</html>
