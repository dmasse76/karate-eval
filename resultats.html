<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>R√©sultats √âvaluations Karat√©</title>
    <link rel="stylesheet" href="./style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container">
    <header class="header">
        <div class="header-content">
            <h1>R√©sultats des √©valuations</h1>
            <div class="subtitle">Donn√©es r√©cup√©r√©es depuis Okinawa üáØüáµ</div>
        </div>
    </header>
    <section class="controls">
        <div class="control-group">
            <label for="promotionSelect">Choisir une promotion</label>
            <select id="promotionSelect">
                <option value="">Chargement‚Ä¶</option>
            </select>
        </div>
        <div id="legend" style="margin-top:10px; display:flex; gap:14px; justify-content:center; font-size:0.9rem;">
            <div><span style="display:inline-block;width:14px;height:14px;border-radius:4px;background:#CD001A;color:#fff;vertical-align:middle;margin-right:4px;"></span>&lt; 50 : √âchec</div>
            <div><span style="display:inline-block;width:14px;height:14px;border-radius:4px;background:#F47920;color:#000;vertical-align:middle;margin-right:4px;"></span>50‚Äì59 : Faible (√Ä discuter)</div>
            <div><span style="display:inline-block;width:14px;height:14px;border-radius:4px;background:#FFE900;color:#000;vertical-align:middle;margin-right:4px;"></span>60‚Äì69 : Passable (√Ä discuter)</div>
            <div><span style="display:inline-block;width:14px;height:14px;border-radius:4px;background:#43a838;color:#fff;vertical-align:middle;margin-right:4px;"></span>‚â• 70 : R√©ussi</div>
        </div>
    </section>
    <main class="content-area">
        <div id="results-container"></div>
    </main>
</div>

<script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js';

    // --- Initialisation Supabase ---
    const supabaseUrl = "https://gcdruwruygjclvszgerc.supabase.co";
    const supabaseKey = "sb_publishable_NPo8JYU8do60kvTzt_3Wbw_vI3O2DEU";

    //const supabaseUrl = 'http://127.0.0.1:54321'
    //const supabaseKey = 'sb_secret_N7UND0UgjKTVK-Uodkm0Hg_xSvEMPvz'

    const supabase = createClient(supabaseUrl, supabaseKey);

    // --- Elements DOM ---
    const promotionSelect = document.getElementById("promotionSelect");
    const resultsContainer = document.getElementById("results-container");

    // --- Charger promotions uniques ---
    async function loadPromotions() {
        const { data, error } = await supabase
            .from("evaluation_results_view")
            .select("promotion_name")
            .neq("promotion_name", null);

        if (error) {
            console.error(error);
            promotionSelect.innerHTML = "<option>Erreur de chargement</option>";
            return;
        }

        const uniquePromotions = [...new Set(data.map(d => d.promotion_name))];
        promotionSelect.innerHTML = '<option value="">S√©lectionnez‚Ä¶</option>' +
            uniquePromotions.map(p => `<option value="${p}">${p}</option>`).join("");
    }

    // --- Charger r√©sultats d'une promotion ---
    async function loadPromotionResults(promotion) {
        resultsContainer.innerHTML = "<div class='empty-state'><span class='icon'>‚è≥</span><br>Chargement‚Ä¶</div>";

        const { data, error } = await supabase
            .from("evaluation_results_view")
            .select("*")
            .eq("promotion_name", promotion)
            .order("student_name")
            .order("last_saved_at");

        if (error) {
            console.error(error);
            resultsContainer.innerHTML = "<div class='empty-state'><span class='icon'>‚ùå</span><br>Erreur de chargement</div>";
            return;
        }

        if (!data.length) {
            resultsContainer.innerHTML = "<div class='empty-state'><span class='icon'>‚ÑπÔ∏è</span><br>Aucun r√©sultat trouv√©</div>";
            return;
        }

        // Obtenir programme (unique pour la promo)
        const programName = data[0].program_name;

        resultsContainer.innerHTML = `
        <h2 class="subtitle" style="font-size:13px;color:#c41e3a;font-weight:500;margin:18px 0 18px 0;">
            Promotion : ${promotion}
        </h2>
        <h2 class="subtitle" style="font-size:13px;color:#c41e3a;font-weight:500;margin:18px 0 18px 0;">
            Programme : ${programName}
        </h2>


    `;

        // Grouper par √©l√®ve
        const studentsMap = {};
        data.forEach(row => {
            if (!studentsMap[row.student_name]) studentsMap[row.student_name] = [];
            studentsMap[row.student_name].push(row);
        });

        Object.entries(studentsMap).forEach(([studentName, evals]) => {
            resultsContainer.appendChild(renderStudentTable(studentName, evals));
        });
    }

    // --- G√©n√©rer tableau d'un √©l√®ve ---
    function renderStudentTable(studentName, evals) {
        const wrapper = document.createElement("div");
        wrapper.classList.add("technique-card");
        wrapper.style.marginBottom = "18px";

        // Header cliquable (accord√©on)
        const header = document.createElement("div");
        header.className = "technique-header";
        header.style.cursor = "pointer";
        header.style.display = "flex";
        header.style.alignItems = "center";
        header.style.justifyContent = "space-between";
        // Nom de l'√©l√®ve √† gauche
        const nameSpan = document.createElement("span");
        nameSpan.textContent = studentName;
        nameSpan.style.flex = "1";
        nameSpan.style.textAlign = "left";
        // Badge centr√©
        const badge = document.createElement("span");
        badge.className = "status-badge";
        badge.style.margin = "0 auto";
        badge.style.flex = "0 0 auto";
        badge.style.padding = "4px 18px";
        badge.style.borderRadius = "16px";
        badge.style.fontWeight = "600";
        badge.style.fontSize = "0.95em";
        badge.style.lineHeight = "1.6";
        badge.style.display = "inline-block";
        badge.style.letterSpacing = "0.01em";
        // Fl√®che √† droite
        const arrow = document.createElement("span");
        arrow.className = "technique-icon";
        arrow.textContent = "‚ñº";
        arrow.style.flex = "0 0 auto";
        // Ajout dans l'ordre¬†: nom, badge, fl√®che
        header.appendChild(nameSpan);
        header.appendChild(badge);
        header.appendChild(arrow);
        header.onclick = () => {
            wrapper.classList.toggle("open");
        };
        wrapper.appendChild(header);

        // Conteneur accord√©on
        const studentsContainer = document.createElement("div");
        studentsContainer.className = "students-container";

        // Table
        const table = document.createElement("table");
        table.style.width = "100%";
        table.style.background = "rgba(255,255,255,0.95)";
        table.style.borderRadius = "10px";
        table.style.overflow = "hidden";
        table.style.marginTop = "8px";
        table.style.boxShadow = "0 2px 8px rgba(0,0,0,0.05)";
        table.innerHTML = `
        <thead>
            <tr style="background:rgba(196,30,58,0.08);">
                <th style='padding-left:14px;'>√âvaluateur</th>
                <th style='padding-left:14px;'>Note</th>
                <th style='padding-left:14px;'>Inclure</th>
                <th style='padding-left:14px;'>Date</th>
            </tr>
        </thead>
    `;
        const tbody = document.createElement("tbody");

        evals.forEach((ev, idx) => {
            const rowId = `${studentName.replace(/\s/g,'')}-row-${idx}`;
            const tr = document.createElement("tr");
            tr.style.height = "38px";
            tr.innerHTML = `
            <td style='padding-left:14px;'>${ev.evaluator_name}</td>
            <td style='padding-left:14px;'>${ev.total_score}</td>
            <td style='padding-left:14px;'><input type="checkbox" class="include-check" id="${rowId}" checked /></td>
            <td style='padding-left:14px;'>${new Date(ev.last_saved_at).toLocaleDateString()}</td>
        `;
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        studentsContainer.appendChild(table);
        wrapper.appendChild(studentsContainer);

        // Accord√©on ferm√© par d√©faut
        // wrapper.classList.add('open');

        wrapper.style.opacity = 0;
        setTimeout(() => wrapper.style.opacity = 1, 50);
        wrapper.style.transition = "opacity .45s ease";

        computeAverage(studentName, evals, wrapper);

        // Checkbox events
        wrapper.querySelectorAll(".include-check").forEach(ch =>
            ch.addEventListener("change", () => computeAverage(studentName, evals, wrapper))
        );

        return wrapper;
    }

    // --- Calcul de la moyenne + badge + highlight ---
    function computeAverage(studentName, evals, wrapper) {
        const checks = wrapper.querySelectorAll(".include-check");
        let sum = 0;
        let count = 0;
        checks.forEach((ch, idx) => {
            if (ch.checked) {
                sum += evals[idx].total_score;
                count++;
            }
        });
        const avg = count ? Math.round(sum / count) : 0;
        // Badge dans le header
        const badge = wrapper.querySelector('.technique-header .status-badge');
        // Reset backgrounds et ombre
        wrapper.classList.remove("row-green", "row-yellow", "row-orange","row-red");
        badge.textContent = "";
        badge.style.background = "";
        badge.style.color = "";
        wrapper.style.boxShadow = "0 2px 8px rgba(0,0,0,0.05)";
        let bgColor = '', textColor = '', shadowColor = '';
        if (avg >= 70) {
            wrapper.classList.add("row-green");
            badge.textContent = avg + "%";
            bgColor = "#43a838";
            textColor = "#fff";
            badge.style.background = bgColor;
            badge.style.color = textColor;
            shadowColor = '-8px 0 0 0 #43a838, 0 2px 8px rgba(0,0,0,0.05)';
        } else if (avg >= 60) {
            wrapper.classList.add("row-yellow");
            badge.textContent = avg + "%";
            bgColor = "#FFE900";
            textColor = "#000";
            badge.style.background = bgColor;
            badge.style.color = textColor;
            shadowColor = '-8px 0 0 0 #FFE900, 0 2px 8px rgba(0,0,0,0.05)';
        } else if (avg >= 50) {
            wrapper.classList.add("row-orange");
            badge.textContent = avg + "%";
            bgColor = "#F47920";
            textColor = "#000";
            badge.style.background = bgColor;
            badge.style.color = textColor;
            shadowColor = '-8px 0 0 0 #F47920, 0 2px 8px rgba(0,0,0,0.05)';
        } else {
            wrapper.classList.add("row-red");
            badge.textContent = avg + "%";
            bgColor = "#CD001A";
            textColor = "#fff";
            badge.style.background = bgColor;
            badge.style.color = textColor;
            shadowColor = '-8px 0 0 0 #CD001A, 0 2px 8px rgba(0,0,0,0.05)';
        }
        // Appliquer l'ombre color√©e vive uniquement sur le c√¥t√© gauche de la carte technique
        wrapper.style.boxShadow = shadowColor;
    }

    // --- Events ---
    promotionSelect.addEventListener("change", e => {
        const promo = e.target.value;
        if (promo) loadPromotionResults(promo);
    });

    // --- Initialisation ---
    loadPromotions();
</script>
</body>
</html>
