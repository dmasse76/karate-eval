<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Résultats Évaluations Karaté</title>
    <link rel="stylesheet" href="./style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="wrap">
    <div class="card">
        <h1>Résultats des évaluations</h1>
        <p class="muted">Données récupérées depuis Supabase</p>

        <label for="promotionSelect">Choisir une promotion</label>
        <select id="promotionSelect">
            <option value="">Chargement…</option>
        </select>

        <div id="legend" style="margin-top:14px; display:flex; gap:14px; justify-content:center; font-size:0.9rem;">
            <div><span style="display:inline-block;width:14px;height:14px;border-radius:4px;background:rgba(34,197,94,0.35);margin-right:4px;"></span>≥ 70 : Réussi</div>
            <div><span style="display:inline-block;width:14px;height:14px;border-radius:4px;background:rgba(245,158,11,0.35);margin-right:4px;"></span>40–69 : À débattre</div>
            <div><span style="display:inline-block;width:14px;height:14px;border-radius:4px;background:rgba(239,68,68,0.35);margin-right:4px;"></span>&lt; 40 : Échec</div>
        </div>

        <div id="results-container" style="margin-top:20px;"></div>
    </div>
</div>

<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // --- Initialisation Supabase ---
    const supabaseUrl = "https://gcdruwruygjclvszgerc.supabase.co";
    const supabaseKey = "sb_publishable_NPo8JYU8do60kvTzt_3Wbw_vI3O2DEU";
    const supabase = createClient(supabaseUrl, supabaseKey);

    // --- Elements DOM ---
    const promotionSelect = document.getElementById("promotionSelect");
    const resultsContainer = document.getElementById("results-container");

    // --- Charger promotions uniques ---
    async function loadPromotions() {
        const { data, error } = await supabase
            .from("evaluation_results_view")
            .select("promotion_name")
            .neq("promotion_name", null);

        if (error) {
            console.error(error);
            promotionSelect.innerHTML = "<option>Erreur de chargement</option>";
            return;
        }

        const uniquePromotions = [...new Set(data.map(d => d.promotion_name))];
        promotionSelect.innerHTML = '<option value="">Sélectionnez…</option>' +
            uniquePromotions.map(p => `<option value="${p}">${p}</option>`).join("");
    }

    // --- Charger résultats d'une promotion ---
    async function loadPromotionResults(promotion) {
        resultsContainer.innerHTML = "<p class='muted'>Chargement…</p>";

        const { data, error } = await supabase
            .from("evaluation_results_view")
            .select("*")
            .eq("promotion_name", promotion)
            .order("student_name")
            .order("last_saved_at");

        if (error) {
            console.error(error);
            resultsContainer.innerHTML = "<p class='muted'>Erreur de chargement</p>";
            return;
        }

        if (!data.length) {
            resultsContainer.innerHTML = "<p class='muted'>Aucun résultat trouvé</p>";
            return;
        }

        // Obtenir programme (unique pour la promo)
        const programName = data[0].program_name;

        resultsContainer.innerHTML = `
        <h2 style="text-align:center;color:var(--accent);margin-top:10px;">
            Promotion : ${promotion} — Programme : ${programName}
        </h2>
    `;

        // Grouper par élève
        const studentsMap = {};
        data.forEach(row => {
            if (!studentsMap[row.student_name]) studentsMap[row.student_name] = [];
            studentsMap[row.student_name].push(row);
        });

        Object.entries(studentsMap).forEach(([studentName, evals]) => {
            resultsContainer.appendChild(renderStudentTable(studentName, evals));
        });
    }

    // --- Générer tableau d'un élève ---
    function renderStudentTable(studentName, evals) {
        const wrapper = document.createElement("div");
        wrapper.classList.add("table-scroll");

        // Titre + badge
        const title = document.createElement("h3");
        title.style.color = "var(--accent)";
        title.style.display = "flex";
        title.style.alignItems = "center";
        title.style.gap = "8px";
        title.textContent = studentName;

        const badge = document.createElement("span");
        badge.classList.add("status-badge");
        badge.style.padding = "2px 8px";
        badge.style.borderRadius = "6px";
        badge.style.fontSize = "0.8rem";
        badge.style.fontWeight = "600";
        title.appendChild(badge);
        wrapper.appendChild(title);

        // Table
        const table = document.createElement("table");
        table.innerHTML = `
        <thead>
            <tr>
                <th>Évaluateur</th>
                <th>Date</th>
                <th>Note</th>
                <th>Inclure</th>
            </tr>
        </thead>
    `;
        const tbody = document.createElement("tbody");

        evals.forEach((ev, idx) => {
            const rowId = `${studentName.replace(/\s/g,'')}-row-${idx}`;
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>${ev.evaluator_name}</td>
            <td>${new Date(ev.last_saved_at).toLocaleDateString()}</td>
            <td>${ev.total_score}</td>
            <td><input type="checkbox" class="include-check" id="${rowId}" checked /></td>
        `;
            tbody.appendChild(tr);
        });

        // Ligne moyenne
        const avgRow = document.createElement("tr");
        avgRow.innerHTML = `
        <td colspan="2" style="font-weight:bold;">Moyenne</td>
        <td id="avg-${studentName.replace(/\s/g,'')}">0</td>
        <td></td>
    `;
        tbody.appendChild(avgRow);
        table.appendChild(tbody);
        wrapper.appendChild(table);

        wrapper.style.opacity = 0;
        setTimeout(() => wrapper.style.opacity = 1, 50);
        wrapper.style.transition = "opacity .45s ease";

        computeAverage(studentName, evals, wrapper);

        // Checkbox events
        wrapper.querySelectorAll(".include-check").forEach(ch =>
            ch.addEventListener("change", () => computeAverage(studentName, evals, wrapper))
        );

        return wrapper;
    }

    // --- Calcul de la moyenne + badge + highlight ---
    function computeAverage(studentName, evals, wrapper) {
        const checks = wrapper.querySelectorAll(".include-check");
        let sum = 0;
        let count = 0;
        checks.forEach((ch, idx) => {
            if (ch.checked) {
                sum += evals[idx].total_score;
                count++;
            }
        });
        const avg = count ? Math.round(sum / count) : 0;
        const avgCell = wrapper.querySelector(`#avg-${studentName.replace(/\s/g,'')}`);
        avgCell.textContent = avg;

        const row = avgCell.parentElement;
        const badge = wrapper.querySelector(".status-badge");

        // Retirer toutes les classes
        row.classList.remove("row-green", "row-yellow", "row-red");

        if (avg >= 70) {
            row.classList.add("row-green");
            badge.textContent = "Réussi";
            badge.style.background = "#3fbf4c33";
            badge.style.color = "#0b1220";
        } else if (avg >= 40) {
            row.classList.add("row-yellow");
            badge.textContent = "À débattre";
            badge.style.background = "#f5d13d33";
            badge.style.color = "#0b1220";
        } else {
            row.classList.add("row-red");
            badge.textContent = "Échec";
            badge.style.background = "#ff4d4d33";
            badge.style.color = "#fff";
        }
    }

    // --- Events ---
    promotionSelect.addEventListener("change", e => {
        const promo = e.target.value;
        if (promo) loadPromotionResults(promo);
    });

    // --- Initialisation ---
    loadPromotions();
</script>
</body>
</html>
